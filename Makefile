
################################################################
# CONFIG
################################################################
# PATHS
ODIR=obj
LDIR=lib
IDIR=include
SRC=src
DEP=dep

# FILES
BUILDINFO=$(ODIR)/build.info

# CONFIG
PROJ_NAME=acc_rcv
CC=msp430-gcc
CFLAGS=-I$(IDIR) -mmcu=msp430g2553 --vv -g
#LIBS=-lm
LIBS=

## __/\\\\____________/\\\\_____/\\\\\\\\\_____/\\\________/\\\__/\\\\\\\\\\\\\\\_
##  _\/\\\\\\________/\\\\\\___/\\\\\\\\\\\\\__\/\\\_____/\\\//__\/\\\///////////__
##   _\/\\\//\\\____/\\\//\\\__/\\\/////////\\\_\/\\\__/\\\//_____\/\\\_____________
##    _\/\\\\///\\\/\\\/_\/\\\_\/\\\_______\/\\\_\/\\\\\\//\\\_____\/\\\\\\\\\\\_____
##     _\/\\\__\///\\\/___\/\\\_\/\\\\\\\\\\\\\\\_\/\\\//_\//\\\____\/\\\///////______
##      _\/\\\____\///_____\/\\\_\/\\\/////////\\\_\/\\\____\//\\\___\/\\\_____________
##       _\/\\\_____________\/\\\_\/\\\_______\/\\\_\/\\\_____\//\\\__\/\\\_____________
##        _\/\\\_____________\/\\\_\/\\\_______\/\\\_\/\\\______\//\\\_\/\\\\\\\\\\\\\\\_
##         _\///______________\///__\///________\///__\///________\///__\///////////////__
##  _______________/\\\\\\\\\\\_______________________________________________________________
##   _____________/\\\/////////\\\_____________________________________________________________
##    ____________\//\\\______\///______________________________________________________________
##     _____________\////\\\_____________________________________________________________________
##      ________________\////\\\______________________veenkar@gmail.com___________________________
##       ___________________\////\\\_______________________________________________________________
##        ____________/\\\______\//\\\______________________________________________________________
##         ___________\///\\\\\\\\\\\/_______________________________________________________________
##          _____________\///////////_________________________________________________________________
##  ______________________/\\\\\\\\\\\\\________________________/\\\________/\\\\\\\\\\______/\\\\\\\____
##   _____________________\/\\\/////////\\\____________________/\\\\\______/\\\///////\\\___/\\\/////\\\__
##    _____________________\/\\\_______\/\\\__________________/\\\/\\\_____\///______/\\\___/\\\____\//\\\_
##     _____________________\/\\\\\\\\\\\\\/_________________/\\\/\/\\\____________/\\\//___\/\\\_____\/\\\_
##      _____________________\/\\\/////////_________________/\\\/__\/\\\___________\////\\\__\/\\\_____\/\\\_
##       _____________________\/\\\________________________/\\\\\\\\\\\\\\\\___________\//\\\_\/\\\_____\/\\\_
##        _____________________\/\\\_______________________\///////////\\\//___/\\\______/\\\__\//\\\____/\\\__
##         _____________________\/\\\_________________________________\/\\\____\///\\\\\\\\\/____\///\\\\\\\/___
##          _____________________\///__________________________________\///_______\/////////________\///////_____


################################################################
# EXAMPLE CONFIG
################################################################
## # PATHS
## ODIR=obj
## LDIR=lib
## IDIR=include
## SRC=src
## DEP=dep
##
## # FILES
## BUILDINFO=$(ODIR)/build.info
##
## # CONFIG
## PROJ_NAME=acc_rcv
## CC=msp430-gcc
## CFLAGS=-I$(IDIR) -mmcu=msp430g2553 --vv -g
## #LIBS=-lm
## LIBS=


################################################################
# FILE LISTS
################################################################
# full paths
SOURCES := $(wildcard $(SRC)/*.c)
# file names only
_SOURCES = $(patsubst $(SRC)/%,%,$(SOURCES))

#file names only
_OBJ = $(patsubst %.c,%.o,$(_SOURCES))
# full paths
OBJ = $(patsubst %,$(ODIR)/%,$(_OBJ))

################################################################
# ALL
################################################################
all: $(PROJ_NAME)

################################################################
# FLAGS CHANGE DETECTION
################################################################
PREV_CFLAGS := $(shell if [ -f $(BUILDINFO) ]; then cat "${BUILDINFO}"; fi)
$(info curr flags: $(CFLAGS))
#$(info prev flags: $(PREV_CFLAGS))
$(shell if [ "$(PREV_CFLAGS)" != "$(CFLAGS)" ]; then echo "$(CFLAGS)" > $(BUILDINFO); fi)

################################################################
# MAIN
################################################################
$(PROJ_NAME): $(OBJ)
	$(CC) -o $@ $^ $(CFLAGS) $(LIBS)

################################################################
# PHONIES CONFIG
################################################################
.PHONY: clean all

################################################################
# DEPENDENCIES
################################################################
$(DEP)/%.d: $(SRC)/%.c
	@set -e; rm -f $@; \
	$(CC) -M $(CPPFLAGS) -I $(IDIR) $< > $@.$$$$; \
	sed 's,\($*\)\.o[ :]*,$(ODIR)/\1.o $@ : $(BUILDINFO) ,g' < $@.$$$$ > $@; \
	rm -f $@.$$$$

################################################################
# INCLUDE DEPENDENCIES TO THIS MAKEFILE
################################################################
_DEPS = $(patsubst %.c,%.d,$(_SOURCES))
DEPS = $(patsubst %,$(DEP)/%,$(_DEPS))
-include $(DEPS)

################################################################
# OBJECTS
################################################################
$(ODIR)/%.o: $(SRC)/%.c $(DEP)/%.d
	$(CC) -c -o $@ $< $(CFLAGS)

################################################################
# CLEAN
################################################################
clean:
	rm -f $(PROJ_NAME) $(ODIR)/*.o $(BUILDINFO) $(DEP)/*.d $(ODIR)/*.d.* *~ core $(INCDIR)/*~
